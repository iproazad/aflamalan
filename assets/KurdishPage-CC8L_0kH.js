import{c as Q,r as a,a as U,s as S,f as V,j as s}from"./index-DLOQmAiS.js";import{H as Z,a as J}from"./HeroSliderSkeleton-qcGs03X6.js";import{S as K,G as W,T as X,Y as ee}from"./TagFilter-BtRfVG1f.js";import{M as te}from"./MovieGrid-BYeTr3fp.js";import{M as se}from"./MovieGridSkeleton-BIC0evs_.js";import{P as re}from"./Pagination-BQtzf5ih.js";import"./MovieCardSkeleton-B2tHPRXo.js";import"./useWatchLater-9hxFhDiQ.js";const w=30,ae=[{key:"foreign",label:"افلام اجنبي"},{key:"kurdish",label:"افلام كردي"},{key:"asian",label:"افلام اسيوية"},{key:"turkish",label:"افلام تركية"},{key:"arabic",label:"افلام عربي"},{key:"classic",label:"افلام كلاسيكيه"},{key:"dubbed",label:"افلام مدبلجة"},{key:"indian",label:"افلام هندية"},{key:"anime",label:"افلام انمي"}],A=async n=>{let l=[],o=0;const m=1e3;for(;;){const{data:g,error:u,count:x}=await S.from("movies").select("*",{count:"exact"}).eq("movie_type",n).order("created_at",{ascending:!1}).range(o,o+m-1);if(u)throw console.error(`Error fetching a batch of ${n} movies: `,u.message),u;if(g){if(l=l.concat(g),l.length>=(x??0)||g.length<m)break;o+=m}else break}return l},ue=()=>{var G;const{type:n}=Q(),[l,o]=a.useState([]),[m,g]=a.useState([]),[u,x]=a.useState(!0),[_,k]=a.useState(null),[c,F]=a.useState("all"),[i,N]=a.useState([]),[d,T]=a.useState([]),[h,D]=a.useState("createdAt_desc"),[f,Y]=a.useState(""),[v,C]=U(),M=a.useRef(!0),b=parseInt(v.get("page")||"1",10),p=((G=ae.find(e=>e.key===n))==null?void 0:G.label)||"أفلام",E=a.useCallback(e=>{const t=new URLSearchParams(v);e<=1?t.delete("page"):t.set("page",e.toString()),C(t,{replace:!0}),window.scrollTo(0,0)},[v,C]);a.useEffect(()=>{(async()=>{if(n){x(!0);try{const r=await A(n);o(r)}catch(r){console.error(`Error fetching ${n} movies: `,r),k("فشل تحميل الأفلام. تأكد من أن جدول 'movies' موجود وأن سياسات RLS تسمح بالوصول للقراءة.")}finally{x(!1)}}})();const t=S.channel(`public:movies:${n}`).on("postgres_changes",{event:"*",schema:"public",table:"movies",filter:`movie_type=eq.${n}`},()=>{n&&A(n).then(o).catch(r=>console.error("Error on subscription refetch:",r))}).subscribe();return()=>{S.removeChannel(t)}},[n]),a.useEffect(()=>{(async()=>{const{data:t,error:r}=await S.from("categories").select("name").order("name");r?(console.error("Error fetching categories: ",r.message),k(y=>(y?y+`
`:"")+"فشل تحميل الفئات.")):g(t.map(y=>y.name))})()},[]);const $=e=>{N(t=>t.includes(e)?t.filter(r=>r!==e):[...t,e])},R=()=>N([]),H=e=>T(t=>t.includes(e)?t.filter(r=>r!==e):[...t,e]),I=()=>T([]),z=[...new Set(l.map(e=>e.year))].sort((e,t)=>t-e),L=m,O=[...new Set(l.flatMap(e=>e.tags||[]))].sort(),j=a.useMemo(()=>l.filter(e=>c==="all"||e.year.toString()===c).filter(e=>i.length===0||i.some(t=>{var r;return(r=e.genres)==null?void 0:r.includes(t)})).filter(e=>d.length===0||d.some(t=>{var r;return(r=e.tags)==null?void 0:r.includes(t)})).filter(e=>V(f,e.title)).sort((e,t)=>{switch(h){case"rating_desc":return(t.imdb_rating||0)-(e.imdb_rating||0);case"rating_asc":return(e.imdb_rating||0)-(t.imdb_rating||0);case"year_desc":return Number(t.year)-Number(e.year);case"year_asc":return Number(e.year)-Number(t.year);case"createdAt_asc":return Date.parse(e.created_at)-Date.parse(t.created_at);case"createdAt_desc":default:return Date.parse(t.created_at)-Date.parse(e.created_at)}}),[l,c,i,d,f,h]);a.useEffect(()=>{if(M.current){M.current=!1;return}b!==1&&E(1)},[c,i,d,f,h]);const P=Math.ceil(j.length/w),q=j.slice((b-1)*w,b*w),B=f!==""||c!=="all"||i.length>0||d.length>0||h!=="createdAt_desc";return u?s.jsxs("div",{children:[s.jsx(Z,{}),s.jsx("div",{className:"my-8 h-20 bg-gray-800/50 rounded-lg animate-pulse"}),s.jsxs("section",{className:"mb-12",children:[s.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:p}),s.jsx(se,{count:18})]})]}):_&&l.length===0?s.jsxs("div",{className:"text-center p-8 bg-red-900/20 border border-red-500/50 rounded-lg mt-8 animate-fade-in",children:[s.jsx("h2",{className:"text-2xl text-red-400 mb-4",children:"حدث خطأ في الاتصال بقاعدة البيانات"}),s.jsx("p",{className:"text-slate-300 whitespace-pre-line",children:_})]}):s.jsxs("div",{className:"animate-fade-in",children:[s.jsx(J,{movies:l.slice(0,5)}),s.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:s.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[s.jsx("input",{type:"text",value:f,onChange:e=>Y(e.target.value),placeholder:`ابحث في ${p}...`,className:"w-full md:w-auto md:flex-grow bg-slate-700 text-white p-2 pl-4 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none","aria-label":"Search within this category"}),s.jsx(K,{sortOrder:h,onSortChange:D}),s.jsx(W,{genres:L,selectedGenres:i,onToggleGenre:$,onClearGenres:R}),s.jsx(X,{tags:O,selectedTags:d,onToggleTag:H,onClearTags:I}),s.jsx(ee,{years:z,selectedYear:c,onYearChange:F})]})}),s.jsxs("section",{className:"mb-12",children:[s.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:B?`نتائج البحث في ${p}`:p}),j.length>0?s.jsxs(s.Fragment,{children:[s.jsx(te,{movies:q}),P>1&&s.jsx(re,{currentPage:b,totalPages:P,onPageChange:E})]}):s.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:s.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام في هذه الفئة تطابق معايير البحث."})})]})]})};export{ue as default};
