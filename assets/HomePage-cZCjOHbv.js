import{r as a,u as X,a as ee,s as i,f as te,j as t}from"./index-DLOQmAiS.js";import{H as se,a as re}from"./HeroSliderSkeleton-qcGs03X6.js";import{M as E}from"./MoviesCarousel-BwU9xilG.js";import{S as ae,G as ne,T as le,Y as oe}from"./TagFilter-BtRfVG1f.js";import{u as ce}from"./useWatchLater-9hxFhDiQ.js";import{M as ie}from"./MovieGrid-BYeTr3fp.js";import{M as de}from"./MovieGridSkeleton-BIC0evs_.js";import{M as k}from"./MoviesCarouselSkeleton-CYrzEe1q.js";import{P as me}from"./Pagination-BQtzf5ih.js";import"./MovieCardSkeleton-B2tHPRXo.js";const P=30,U=async()=>{let n=[],d=0;const h=1e3;for(;;){const{data:m,error:x,count:p}=await i.from("movies").select("*",{count:"exact"}).or("movie_type.eq.foreign,movie_type.is.null").order("created_at",{ascending:!1}).range(d,d+h-1);if(x)throw console.error("Error fetching a batch of movies: ",x.message),x;if(m){if(n=n.concat(m),n.length>=(p??0)||m.length<h)break;d+=h}else break}return n},Se=()=>{const[n,d]=a.useState([]),[h,m]=a.useState([]),[x,p]=a.useState(!0),[T,G]=a.useState(null),[l,v]=a.useState("all"),[o,y]=a.useState([]),[c,j]=a.useState([]),[S,z]=a.useState("createdAt_desc"),[u,N]=a.useState(""),{currentUser:F}=X(),{favorites:B}=ce(),[f,R]=ee(),C=a.useRef(null),A=a.useRef(!0),w=parseInt(f.get("page")||"1",10),I=a.useCallback(e=>{var r;const s=new URLSearchParams(f);e<=1?s.delete("page"):s.set("page",e.toString()),R(s,{replace:!0}),(r=document.getElementById("filters-section"))==null||r.scrollIntoView({behavior:"smooth",block:"start"})},[f,R]);a.useEffect(()=>{(async()=>{p(!0);try{const r=await U();d(r)}catch(r){G("فشل تحميل الأفلام. تأكد من أن جدول 'movies' موجود وأن سياسات RLS تسمح بالوصول للقراءة."),console.error("Error fetching movies: ",r)}finally{p(!1)}})();const s=i.channel("public:movies").on("postgres_changes",{event:"*",schema:"public",table:"movies"},()=>{U().then(d).catch(r=>console.error("Error refetching movies on subscription:",r))}).subscribe();return()=>{i.removeChannel(s)}},[]),a.useEffect(()=>{(async()=>{const{data:r,error:b}=await i.from("categories").select("name").order("name");b?(console.error("Error fetching categories: ",b.message),G(g=>(g?g+`
`:"")+"فشل تحميل الفئات. تأكد من أن جدول 'categories' موجود.")):m(r.map(g=>g.name))})();const s=i.channel("public:categories").on("postgres_changes",{event:"*",schema:"public",table:"categories"},()=>{i.from("categories").select("name").order("name").then(({data:r,error:b})=>{b?console.error("Error refetching categories on subscription:",b.message):r&&m(r.map(g=>g.name))})}).subscribe();return()=>{i.removeChannel(s)}},[]);const D=e=>{y(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},O=()=>{y([])},Y=e=>{j(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},V=()=>{j([])},$=()=>{N(""),v("all"),y([]),j([]),C.current=null},H=n.filter(e=>B.includes(e.id)),q=n.slice(0,15),Q=[...n].sort((e,s)=>(s.imdb_rating||0)-(e.imdb_rating||0)).slice(0,15),Z=[...new Set(n.map(e=>e.year))].sort((e,s)=>s-e),J=h,K=[...new Set(n.flatMap(e=>e.tags||[]))].sort(),_=a.useMemo(()=>n.filter(e=>l==="all"||e.year.toString()===l).filter(e=>o.length===0?!0:o.some(s=>{var r;return(r=e.genres)==null?void 0:r.includes(s)})).filter(e=>c.length===0?!0:c.some(s=>{var r;return(r=e.tags)==null?void 0:r.includes(s)})).filter(e=>te(u,e.title)).sort((e,s)=>{switch(S){case"rating_desc":return(s.imdb_rating||0)-(e.imdb_rating||0);case"rating_asc":return(e.imdb_rating||0)-(s.imdb_rating||0);case"year_desc":return Number(s.year)-Number(e.year);case"year_asc":return Number(e.year)-Number(s.year);case"createdAt_asc":return Date.parse(e.created_at)-Date.parse(s.created_at);case"createdAt_desc":default:return Date.parse(s.created_at)-Date.parse(e.created_at)}}),[n,l,o,c,u,S]);a.useEffect(()=>{if(A.current){A.current=!1;return}w!==1&&I(1)},[l,o,c,u,S]),a.useEffect(()=>{var s;const e=f.get("genre");e&&e!==C.current&&(N(""),v("all"),j([]),y([e]),C.current=e,(s=document.getElementById("filters-section"))==null||s.scrollIntoView({behavior:"smooth",block:"start"}))},[f]);const L=Math.ceil(_.length/P),W=_.slice((w-1)*P,w*P),M=u!==""||l!=="all"||o.length>0||c.length>0;return x?t.jsxs("div",{children:[t.jsx(se,{}),t.jsx("div",{className:"my-8 h-20 bg-gray-800/50 rounded-lg animate-pulse"}),F&&t.jsx(k,{title:"المفضلة"}),t.jsx(k,{title:"أحدث الإضافات"}),t.jsx(k,{title:"الأعلى تقييماً"}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:"تصفح الكل"}),t.jsx(de,{count:18})]})]}):T&&n.length===0?t.jsxs("div",{className:"text-center p-8 bg-red-900/20 border border-red-500/50 rounded-lg mt-8 animate-fade-in",children:[t.jsx("h2",{className:"text-2xl text-red-400 mb-4",children:"حدث خطأ في الاتصال بقاعدة البيانات"}),t.jsx("p",{className:"text-slate-300 whitespace-pre-line",children:T}),t.jsx("p",{className:"text-slate-400 mt-4",children:"This usually means the database tables are not set up correctly or Row Level Security (RLS) is preventing access. Please check your Supabase dashboard to ensure the 'movies' and 'categories' tables are readable by anonymous users."})]}):t.jsxs("div",{className:"animate-fade-in",children:[t.jsx(re,{movies:n.slice(0,5)}),t.jsx("div",{id:"filters-section",className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl scroll-mt-20",children:t.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[t.jsx(ae,{sortOrder:S,onSortChange:z}),t.jsx(ne,{genres:J,selectedGenres:o,onToggleGenre:D,onClearGenres:O}),t.jsx(le,{tags:K,selectedTags:c,onToggleTag:Y,onClearTags:V}),t.jsx(oe,{years:Z,selectedYear:l,onYearChange:v})]})}),M&&t.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-gray-800/50 p-3 animate-fade-in-down",children:[t.jsx("span",{className:"font-bold text-gray-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[u&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-yellow-900/50 px-3 py-1 text-sm text-yellow-300",children:['بحث: "',u,'"',t.jsx("button",{onClick:()=>N(""),className:"text-yellow-400 hover:text-white text-lg leading-none font-bold","aria-label":"Clear search query",children:"×"})]}),l!=="all"&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",l,t.jsx("button",{onClick:()=>v("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${l}`,children:"×"})]}),o.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,t.jsx("button",{onClick:()=>D(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),c.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,t.jsx("button",{onClick:()=>Y(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),t.jsx("button",{onClick:$,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),!M&&t.jsxs(t.Fragment,{children:[F&&H.length>0&&t.jsx(E,{title:"المفضلة",movies:H}),t.jsx(E,{title:"أحدث الإضافات",movies:q}),t.jsx(E,{title:"الأعلى تقييماً",movies:Q})]}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:M?"نتائج البحث":"تصفح الكل"}),_.length>0?t.jsxs(t.Fragment,{children:[t.jsx(ie,{movies:W}),L>1&&t.jsx(me,{currentPage:w,totalPages:L,onPageChange:I})]}):t.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:t.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام تطابق معايير البحث."})})]})]})};export{Se as default};
