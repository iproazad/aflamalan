import{r as a,u as ee,a as te,d as H,f as se,j as t}from"./index-Dh8Pkb-q.js";import{H as re,a as ae}from"./HeroSliderSkeleton-B2kv5g69.js";import{M as A}from"./MoviesCarousel-CLqgNRV3.js";import{S as le,G as oe,T as ne,Y as ie}from"./TagFilter-Cu3eC4bF.js";import{u as ce}from"./useWatchLater-BiQ9AbZF.js";import{M as de}from"./MovieGrid-CLmviSHu.js";import{M as me}from"./MovieGridSkeleton-B5NCI3A8.js";import{M as C}from"./MoviesCarouselSkeleton-DUZMpcx0.js";import{P as xe}from"./Pagination-o_qdMaqX.js";import"./MovieCardSkeleton-mlncPtAb.js";const N=28,w="cached_movies",ge=900*1e3,Ae=()=>{const[i,E]=a.useState([]),[O,D]=a.useState([]),[U,T]=a.useState(!0),[n,u]=a.useState("all"),[c,f]=a.useState([]),[d,h]=a.useState([]),[p,z]=a.useState("createdAt_desc"),[m,y]=a.useState(""),{currentUser:R}=ee(),{favorites:K}=ce(),[G]=te(),j=a.useRef(null),[b,_]=a.useState(1);a.useEffect(()=>{(async()=>{try{const s=localStorage.getItem(w);if(s){const{data:r,timestamp:o}=JSON.parse(s);if(new Date().getTime()-o<ge){E(r),T(!1);return}}}catch(s){console.error("Error reading from movie cache",s),localStorage.removeItem(w)}try{const o=(await H.collection("movies").get()).docs.map(l=>({id:l.id,...l.data()})).filter(l=>l.isKurdish!==!0);o.sort((l,x)=>{var Y,B;const g=(Y=l.createdAt)!=null&&Y.toMillis?l.createdAt.toMillis():0;return((B=x.createdAt)!=null&&B.toMillis?x.createdAt.toMillis():0)-g}),E(o);try{const l={data:o,timestamp:new Date().getTime()};localStorage.setItem(w,JSON.stringify(l))}catch(l){console.error("Error writing to movie cache",l)}}catch(s){console.error("Error fetching movies: ",s)}finally{T(!1)}})()},[]),a.useEffect(()=>{const e=H.collection("categories").orderBy("name").onSnapshot(s=>{const r=s.docs.map(o=>o.data().name);D(r)},s=>{console.error("Error fetching categories: ",s)});return()=>e()},[]);const k=e=>{f(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},$=()=>{f([])},F=e=>{h(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},J=()=>{h([])},Q=()=>{y(""),u("all"),f([]),h([]),j.current=null},P=i.filter(e=>K.includes(e.id)),V=i.slice(0,15),q=[...i].sort((e,s)=>(s.imdbRating||0)-(e.imdbRating||0)).slice(0,15),L=[...new Set(i.map(e=>e.year))].sort((e,s)=>s-e),W=O,X=[...new Set(i.flatMap(e=>e.tags||[]))].sort(),M=a.useMemo(()=>i.filter(e=>n==="all"||e.year.toString()===n).filter(e=>c.length===0?!0:c.some(s=>{var r;return(r=e.genres)==null?void 0:r.includes(s)})).filter(e=>d.length===0?!0:d.some(s=>{var r;return(r=e.tags)==null?void 0:r.includes(s)})).filter(e=>se(m,e.title)).sort((e,s)=>{var r,o,l,x;switch(p){case"rating_desc":return(s.imdbRating||0)-(e.imdbRating||0);case"rating_asc":return(e.imdbRating||0)-(s.imdbRating||0);case"year_desc":return s.year-e.year;case"year_asc":return e.year-s.year;case"createdAt_asc":{const g=(r=e.createdAt)!=null&&r.toMillis?e.createdAt.toMillis():0,v=(o=s.createdAt)!=null&&o.toMillis?s.createdAt.toMillis():0;return g-v}case"createdAt_desc":default:{const g=(l=s.createdAt)!=null&&l.toMillis?s.createdAt.toMillis():0,v=(x=e.createdAt)!=null&&x.toMillis?e.createdAt.toMillis():0;return g-v}}}),[i,n,c,d,m,p]);a.useEffect(()=>{_(1)},[n,c,d,m,p]),a.useEffect(()=>{var s;const e=G.get("genre");e&&e!==j.current&&(y(""),u("all"),h([]),f([e]),j.current=e,(s=document.getElementById("filters-section"))==null||s.scrollIntoView({behavior:"smooth",block:"start"}))},[G]);const I=Math.ceil(M.length/N),Z=M.slice((b-1)*N,b*N),S=m!==""||n!=="all"||c.length>0||d.length>0;return U?t.jsxs("div",{children:[t.jsx(re,{}),t.jsx("div",{className:"my-8 h-20 bg-gray-800/50 rounded-lg animate-pulse"}),R&&t.jsx(C,{title:"المفضلة"}),t.jsx(C,{title:"أحدث الإضافات"}),t.jsx(C,{title:"الأعلى تقييماً"}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:"تصفح الكل"}),t.jsx(me,{count:18})]})]}):t.jsxs("div",{className:"animate-fade-in",children:[t.jsx(ae,{movies:i.slice(0,5)}),t.jsx("div",{id:"filters-section",className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl scroll-mt-20",children:t.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[t.jsx(le,{sortOrder:p,onSortChange:z}),t.jsx(oe,{genres:W,selectedGenres:c,onToggleGenre:k,onClearGenres:$}),t.jsx(ne,{tags:X,selectedTags:d,onToggleTag:F,onClearTags:J}),t.jsx(ie,{years:L,selectedYear:n,onYearChange:u})]})}),S&&t.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-gray-800/50 p-3 animate-fade-in-down",children:[t.jsx("span",{className:"font-bold text-gray-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[m&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-yellow-900/50 px-3 py-1 text-sm text-yellow-300",children:['بحث: "',m,'"',t.jsx("button",{onClick:()=>y(""),className:"text-yellow-400 hover:text-white text-lg leading-none font-bold","aria-label":"Clear search query",children:"×"})]}),n!=="all"&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",n,t.jsx("button",{onClick:()=>u("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${n}`,children:"×"})]}),c.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,t.jsx("button",{onClick:()=>k(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),d.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,t.jsx("button",{onClick:()=>F(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),t.jsx("button",{onClick:Q,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),!S&&t.jsxs(t.Fragment,{children:[R&&P.length>0&&t.jsx(A,{title:"المفضلة",movies:P}),t.jsx(A,{title:"أحدث الإضافات",movies:V}),t.jsx(A,{title:"الأعلى تقييماً",movies:q})]}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:S?"نتائج البحث":"تصفح الكل"}),M.length>0?t.jsxs(t.Fragment,{children:[t.jsx(de,{movies:Z}),I>1&&t.jsx(xe,{currentPage:b,totalPages:I,onPageChange:_})]}):t.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:t.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام تطابق معايير البحث."})})]})]})};export{Ae as default};
