import{c as Q,r as a,a as B,s as f,f as U,j as s}from"./index-DwgRMzof.js";import{H as V,a as J}from"./HeroSliderSkeleton-DHSKmxge.js";import{S as K,G as W,T as X,Y as Z}from"./TagFilter-JVYl82mc.js";import{M as ee}from"./MovieGrid-m6GG350v.js";import{M as te}from"./MovieGridSkeleton-BtaOLt9l.js";import{P as se}from"./Pagination-Dbqi9frJ.js";import"./MovieCardSkeleton-Bj3zBlMB.js";import"./useWatchLater-BG8eEGx7.js";const p=30,ae=[{key:"foreign",label:"افلام اجنبي"},{key:"kurdish",label:"افلام كردي"},{key:"asian",label:"افلام اسيوية"},{key:"turkish",label:"افلام تركية"},{key:"arabic",label:"افلام عربي"},{key:"classic",label:"افلام كلاسيكيه"},{key:"dubbed",label:"افلام مدبلجة"},{key:"indian",label:"افلام هندية"},{key:"anime",label:"افلام انمي"}],ge=()=>{var C;const{type:n}=Q(),[o,P]=a.useState([]),[M,E]=a.useState([]),[G,y]=a.useState(!0),[S,j]=a.useState(null),[c,A]=a.useState("all"),[i,v]=a.useState([]),[d,_]=a.useState([]),[m,F]=a.useState("createdAt_desc"),[g,Y]=a.useState(""),[x,w]=B(),N=a.useRef(!0),u=parseInt(x.get("page")||"1",10),h=((C=ae.find(e=>e.key===n))==null?void 0:C.label)||"أفلام",T=a.useCallback(e=>{const t=new URLSearchParams(x);e<=1?t.delete("page"):t.set("page",e.toString()),w(t,{replace:!0}),window.scrollTo(0,0)},[x,w]);a.useEffect(()=>{const e=async()=>{if(!n)return;y(!0);const{data:r,error:l}=await f.from("movies").select("*").eq("movie_type",n).order("created_at",{ascending:!1});l?(console.error(`Error fetching ${n} movies: `,l.message),j("فشل تحميل الأفلام. تأكد من أن جدول 'movies' موجود وأن سياسات RLS تسمح بالوصول للقراءة.")):P(r),y(!1)};e();const t=f.channel(`public:movies:${n}`).on("postgres_changes",{event:"*",schema:"public",table:"movies",filter:`movie_type=eq.${n}`},e).subscribe();return()=>{f.removeChannel(t)}},[n]),a.useEffect(()=>{(async()=>{const{data:t,error:r}=await f.from("categories").select("name").order("name");r?(console.error("Error fetching categories: ",r.message),j(l=>(l?l+`
`:"")+"فشل تحميل الفئات.")):E(t.map(l=>l.name))})()},[]);const D=e=>{v(t=>t.includes(e)?t.filter(r=>r!==e):[...t,e])},R=()=>v([]),$=e=>_(t=>t.includes(e)?t.filter(r=>r!==e):[...t,e]),z=()=>_([]),H=[...new Set(o.map(e=>e.year))].sort((e,t)=>t-e),I=M,L=[...new Set(o.flatMap(e=>e.tags||[]))].sort(),b=a.useMemo(()=>o.filter(e=>c==="all"||e.year.toString()===c).filter(e=>i.length===0||i.some(t=>{var r;return(r=e.genres)==null?void 0:r.includes(t)})).filter(e=>d.length===0||d.some(t=>{var r;return(r=e.tags)==null?void 0:r.includes(t)})).filter(e=>U(g,e.title)).sort((e,t)=>{switch(m){case"rating_desc":return(t.imdb_rating||0)-(e.imdb_rating||0);case"rating_asc":return(e.imdb_rating||0)-(t.imdb_rating||0);case"year_desc":return Number(t.year)-Number(e.year);case"year_asc":return Number(e.year)-Number(t.year);case"createdAt_asc":return Date.parse(e.created_at)-Date.parse(t.created_at);case"createdAt_desc":default:return Date.parse(t.created_at)-Date.parse(e.created_at)}}),[o,c,i,d,g,m]);a.useEffect(()=>{if(N.current){N.current=!1;return}u!==1&&T(1)},[c,i,d,g,m]);const k=Math.ceil(b.length/p),O=b.slice((u-1)*p,u*p),q=g!==""||c!=="all"||i.length>0||d.length>0||m!=="createdAt_desc";return G?s.jsxs("div",{children:[s.jsx(V,{}),s.jsx("div",{className:"my-8 h-20 bg-gray-800/50 rounded-lg animate-pulse"}),s.jsxs("section",{className:"mb-12",children:[s.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:h}),s.jsx(te,{count:18})]})]}):S&&o.length===0?s.jsxs("div",{className:"text-center p-8 bg-red-900/20 border border-red-500/50 rounded-lg mt-8 animate-fade-in",children:[s.jsx("h2",{className:"text-2xl text-red-400 mb-4",children:"حدث خطأ في الاتصال بقاعدة البيانات"}),s.jsx("p",{className:"text-slate-300 whitespace-pre-line",children:S})]}):s.jsxs("div",{className:"animate-fade-in",children:[s.jsx(J,{movies:o.slice(0,5)}),s.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:s.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[s.jsx("input",{type:"text",value:g,onChange:e=>Y(e.target.value),placeholder:`ابحث في ${h}...`,className:"w-full md:w-auto md:flex-grow bg-slate-700 text-white p-2 pl-4 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none","aria-label":"Search within this category"}),s.jsx(K,{sortOrder:m,onSortChange:F}),s.jsx(W,{genres:I,selectedGenres:i,onToggleGenre:D,onClearGenres:R}),s.jsx(X,{tags:L,selectedTags:d,onToggleTag:$,onClearTags:z}),s.jsx(Z,{years:H,selectedYear:c,onYearChange:A})]})}),s.jsxs("section",{className:"mb-12",children:[s.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:q?`نتائج البحث في ${h}`:h}),b.length>0?s.jsxs(s.Fragment,{children:[s.jsx(ee,{movies:O}),k>1&&s.jsx(se,{currentPage:u,totalPages:k,onPageChange:T})]}):s.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:s.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام في هذه الفئة تطابق معايير البحث."})})]})]})};export{ge as default};
