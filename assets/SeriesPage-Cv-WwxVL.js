import{r,a as V,s as h,j as a}from"./index-BwkEdhce.js";import{S as X,G as Z,T as ee,Y as te}from"./TagFilter-oIWa-lLK.js";import{M as ae}from"./MovieGridSkeleton-DtWdXLTa.js";import{P as se}from"./Pagination-CJ5RWIom.js";import{S as re}from"./SeriesGrid-CO7PynK6.js";import{a as ne,R as le}from"./ResumeFromModal-CUttwy-D.js";import"./MovieCardSkeleton-CP5jx96s.js";import"./SpinnerIcon-BVd-FKcS.js";const j=30,w="cached_series",ce=900*1e3,ue=()=>{const[i,v]=r.useState([]),[L,k]=r.useState([]),[F,C]=r.useState(!0),[n,f]=r.useState("all"),[c,x]=r.useState([]),[o,u]=r.useState([]),[d,I]=r.useState("createdAt_desc"),[p,N]=V(),_=r.useRef(!0),{addWatchLaterSeries:M,removeWatchLaterSeries:A,isWatchLaterSeries:D,getWatchLaterInfo:T,loading:W}=ne(),[m,S]=r.useState(null),g=parseInt(p.get("page")||"1",10),E=r.useCallback(e=>{const t=new URLSearchParams(p);e<=1?t.delete("page"):t.set("page",e.toString()),N(t,{replace:!0}),window.scrollTo(0,0)},[p,N]);r.useEffect(()=>{(async()=>{try{const t=localStorage.getItem(w);if(t){const{data:s,timestamp:l}=JSON.parse(t);if(new Date().getTime()-l<ce){v(s),C(!1);return}}}catch(t){console.error("Error reading from series cache",t),localStorage.removeItem(w)}try{const{data:t,error:s}=await h.from("series").select("*").order("created_at",{ascending:!1});if(s)throw s;v(t);try{const l={data:t,timestamp:new Date().getTime()};localStorage.setItem(w,JSON.stringify(l))}catch(l){console.error("Error writing to series cache",l)}}catch(t){console.error("Error fetching series: ",t)}finally{C(!1)}})()},[]),r.useEffect(()=>{const e=async()=>{const{data:s,error:l}=await h.from("categories").select("name").order("name");l?console.error("Error fetching categories: ",l):k(s.map(Q=>Q.name))};e();const t=h.channel("public:categories:series").on("postgres_changes",{event:"*",schema:"public",table:"categories"},e).subscribe();return()=>{h.removeChannel(t)}},[]);const P=e=>x(t=>t.includes(e)?t.filter(s=>s!==e):[...t,e]),Y=()=>x([]),R=e=>u(t=>t.includes(e)?t.filter(s=>s!==e):[...t,e]),O=()=>u([]),$=()=>{f("all"),x([]),u([])},H=e=>{D(e.id)?A(e.id):S(e)},J=(e,t)=>{m&&M(m.id,e,t),S(null)},U=[...new Set(i.map(e=>e.year))].sort((e,t)=>t-e),z=L,K=[...new Set(i.flatMap(e=>e.tags||[]))].sort(),b=r.useMemo(()=>i.filter(e=>n==="all"||e.year.toString()===n).filter(e=>c.length===0||c.some(t=>{var s;return(s=e.genres)==null?void 0:s.includes(t)})).filter(e=>o.length===0||o.some(t=>{var s;return(s=e.tags)==null?void 0:s.includes(t)})).sort((e,t)=>{switch(d){case"rating_desc":return(t.imdb_rating||0)-(e.imdb_rating||0);case"rating_asc":return(e.imdb_rating||0)-(t.imdb_rating||0);case"year_desc":return t.year-e.year;case"year_asc":return e.year-t.year;case"createdAt_asc":return Date.parse(e.created_at)-Date.parse(t.created_at);case"createdAt_desc":default:return Date.parse(t.created_at)-Date.parse(e.created_at)}}),[i,n,c,o,d]);r.useEffect(()=>{if(_.current){_.current=!1;return}g!==1&&E(1)},[n,c,o,d]);const G=Math.ceil(b.length/j),y=b.slice((g-1)*j,g*j),q=n!=="all"||c.length>0||o.length>0,B=r.useMemo(()=>new Map(y.map(e=>{const t=T(e.id);return[e.id,t?{season:t.season,episode:t.episode}:null]})),[y,T]);return F?a.jsxs("div",{className:"animate-fade-in",children:[a.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),a.jsx("div",{className:"my-8 h-20 bg-slate-800/50 rounded-lg animate-pulse"}),a.jsx(ae,{count:18})]}):a.jsxs("div",{className:"animate-fade-in",children:[a.jsx(le,{isOpen:!!m,onClose:()=>S(null),series:m,onSave:J,isSaving:W}),a.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),a.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:a.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[a.jsx(X,{sortOrder:d,onSortChange:I}),a.jsx(Z,{genres:z,selectedGenres:c,onToggleGenre:P,onClearGenres:Y}),a.jsx(ee,{tags:K,selectedTags:o,onToggleTag:R,onClearTags:O}),a.jsx(te,{years:U,selectedYear:n,onYearChange:f})]})}),q&&a.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-slate-800/50 p-3 animate-fade-in-down",children:[a.jsx("span",{className:"font-bold text-slate-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),a.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[n!=="all"&&a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",n,a.jsx("button",{onClick:()=>f("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${n}`,children:"×"})]}),c.map(e=>a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,a.jsx("button",{onClick:()=>P(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),o.map(e=>a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,a.jsx("button",{onClick:()=>R(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),a.jsx("button",{onClick:$,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),a.jsx("section",{className:"mb-12",children:b.length>0?a.jsxs(a.Fragment,{children:[a.jsx(re,{series:y,onToggleWatchLater:H,watchLaterInfoMap:B}),G>1&&a.jsx(se,{currentPage:g,totalPages:G,onPageChange:E})]}):a.jsx("div",{className:"text-center p-8 bg-slate-800 rounded-lg mt-8",children:a.jsx("p",{className:"text-xl text-slate-400",children:"لا توجد مسلسلات تطابق معايير البحث."})})})]})};export{ue as default};
