import{u as _,r as u,s as f,R as y,j as s,L as S}from"./index-DwgRMzof.js";import{a as N}from"./MovieCardSkeleton-Bj3zBlMB.js";import{F as k,S as C}from"./SpinnerIcon-CdPsO9m0.js";const R=()=>{const{currentUser:e}=_(),[t,r]=u.useState([]);u.useEffect(()=>{if(!e){r([]);return}(async()=>{const{data:l,error:i}=await f.from("user_lists").select("favorite_series").eq("user_id",e.uid).single();l&&l.favorite_series?r(l.favorite_series):i&&i.code!=="PGRST116"&&console.error("Error fetching initial series favorites:",i)})();const p=f.channel(`user-series-favorites-${e.uid}`).on("postgres_changes",{event:"*",schema:"public",table:"user_lists",filter:`user_id=eq.${e.uid}`},l=>{var o;const i=((o=l.new)==null?void 0:o.favorite_series)||[];r(i)}).subscribe();return()=>{f.removeChannel(p)}},[e]);const v=u.useCallback(async n=>{if(!e){console.warn("User must be logged in to manage favorite series.");return}const l=t.includes(n)?t.filter(o=>o!==n):[...t,n];r(l);const{error:i}=await f.from("user_lists").upsert({user_id:e.uid,favorite_series:l});i&&(console.error("Error toggling favorite series in Supabase:",i),r(t))},[e,t]),h=u.useCallback(n=>t.includes(n),[t]);return{favoriteSeries:t,toggleFavoriteSeries:v,isFavoriteSeries:h}},M=()=>{const{currentUser:e}=_(),[t,r]=u.useState([]),[v,h]=u.useState(!1);u.useEffect(()=>{if(!e){r([]);return}(async()=>{const{data:c,error:d}=await f.from("user_lists").select("watch_later_series").eq("user_id",e.uid).single();if(c&&c.watch_later_series){const b=c.watch_later_series;b.sort((x,a)=>new Date(a.added_at).getTime()-new Date(x.added_at).getTime()),r(b)}else d&&d.code!=="PGRST116"&&console.error("Error fetching initial series watch later list:",d)})();const m=f.channel(`user-series-watch-later-${e.uid}`).on("postgres_changes",{event:"*",schema:"public",table:"user_lists",filter:`user_id=eq.${e.uid}`},c=>{var b;const d=((b=c.new)==null?void 0:b.watch_later_series)||[];d.sort((x,a)=>new Date(a.added_at).getTime()-new Date(x.added_at).getTime()),r(d)}).subscribe();return()=>{f.removeChannel(m)}},[e]);const n=u.useCallback(async(o,m,c)=>{if(!e){console.warn("User must be logged in to manage watch later list.");return}h(!0);const d={seriesId:o,season:m,episode:c,added_at:new Date().toISOString()},b=[...t.filter(a=>a.seriesId!==o),d];r(b);const{error:x}=await f.from("user_lists").upsert({user_id:e.uid,watch_later_series:b});x&&(console.error("Error adding to watch later series in Supabase:",x),r(t)),h(!1)},[e,t]),p=u.useCallback(async o=>{if(!e)return;h(!0);const m=t.filter(d=>d.seriesId!==o);r(m);const{error:c}=await f.from("user_lists").upsert({user_id:e.uid,watch_later_series:m});c&&(console.error("Error removing from watch later series in Supabase:",c),r(t)),h(!1)},[e,t]),l=u.useCallback(o=>t.some(m=>m.seriesId===o),[t]),i=u.useCallback(o=>t.find(m=>m.seriesId===o),[t]);return{watchLaterSeries:t,addWatchLaterSeries:n,removeWatchLaterSeries:p,isWatchLaterSeries:l,getWatchLaterInfo:i,loading:v}},L=({isFavorite:e})=>s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-5 w-5 sm:h-6 sm:w-6 transition-all duration-300 ${e?"text-red-500":"text-white"}`,fill:e?"currentColor":"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"})}),F=({isWatchLater:e})=>s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-5 w-5 sm:h-6 sm:w-6 transition-all duration-300 ${e?"text-cyan-400":"text-white"}`,fill:e?"currentColor":"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"})}),$=({series:e,isFavorite:t,isWatchLater:r,onToggleFavorite:v,onToggleWatchLater:h,watchLaterInfo:n=null})=>{const{currentUser:p}=_(),{imageRef:l,imageSrc:i,isLoaded:o,handleImageLoad:m}=N(e.poster_url),[c,d]=u.useState(!1),b=g=>{g.preventDefault(),g.stopPropagation(),v(e.id)},x=g=>{g.preventDefault(),g.stopPropagation(),h(e)},a=n?`/series/${e.id}?season=${n.season}&episode=${n.episode}`:`/series/${e.id}`;return s.jsx("div",{className:"relative group",children:s.jsxs(S,{to:a,className:"relative block z-10 rounded-lg overflow-hidden shadow-lg hover:shadow-xl hover:shadow-cyan-500/20 transform transition-all duration-300 ease-in-out group-hover:scale-105 bg-slate-800",children:[p&&s.jsxs("div",{className:"absolute top-1.5 right-1.5 z-20 flex flex-col gap-1.5 opacity-0 group-hover:opacity-100 translate-y-2 group-hover:translate-y-0 transition-all duration-300",children:[s.jsx("button",{onClick:b,className:"p-1.5 bg-slate-900/60 rounded-full hover:bg-slate-900/80 transition-all duration-200 hover:scale-110","aria-label":t?"إزالة من المفضلة":"إضافة إلى المفضلة",children:s.jsx(L,{isFavorite:t})}),s.jsx("button",{onClick:x,className:"p-1.5 bg-slate-900/60 rounded-full hover:bg-slate-900/80 transition-all duration-200 hover:scale-110","aria-label":r?"إزالة من قائمة المشاهدة لاحقاً":"إضافة إلى قائمة المشاهدة لاحقاً",children:s.jsx(F,{isWatchLater:r})})]}),s.jsx("div",{className:"relative w-full aspect-[2/3] bg-slate-800 overflow-hidden",children:s.jsx("img",{ref:l,src:i,onLoad:m,alt:e.title,className:`
              w-full h-full object-cover
              transition-all duration-500 ease-in-out group-hover:opacity-75
              ${o?"scale-100 blur-0 grayscale-0":"scale-110 blur-md grayscale"}
            `})}),s.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent"}),s.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-2 sm:p-3 md:p-4 transition-all duration-300 group-hover:-translate-y-1",children:[s.jsx("h3",{className:"text-white text-sm sm:text-base font-bold truncate",children:e.title}),e.genres&&e.genres.length>0&&s.jsxs("div",{className:"relative mt-1",onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),children:[s.jsx("p",{className:"text-slate-400 text-xs truncate",children:e.genres.join(" / ")}),c&&s.jsx("div",{className:"absolute bottom-full left-0 mb-1 w-max max-w-xs bg-slate-900 text-white text-xs rounded py-1.5 px-3 z-10 shadow-lg border border-slate-700 pointer-events-none animate-fade-in-up-fast",children:e.genres.join(", ")})]}),s.jsxs("div",{className:"mt-1 flex justify-between items-center",children:[s.jsx("p",{className:"text-slate-300 text-xs sm:text-sm",children:e.year}),e.imdb_rating&&e.imdb_rating>0?s.jsxs("div",{className:"flex items-center gap-1.5",title:`IMDb Rating: ${e.imdb_rating}/10`,children:[s.jsx("span",{className:"bg-yellow-500 text-black text-xs sm:text-sm font-bold px-2 py-0.5 rounded-sm",children:"IMDb"}),s.jsx("span",{className:"font-bold text-white text-sm",children:e.imdb_rating.toFixed(1)})]}):s.jsx("div",{className:"h-5"})]}),n&&s.jsxs("div",{className:"mt-1.5 text-center text-xs font-bold text-cyan-200 bg-cyan-500/20 px-2 py-1 rounded-sm",children:["استئناف م",n.season," ح",n.episode]})]})]})})},T=y.memo($),W=({isOpen:e,onClose:t,series:r,onSave:v,isSaving:h})=>{var x;const[n,p]=u.useState(1),[l,i]=u.useState(1);if(u.useEffect(()=>{if(r&&r.seasons.length>0){const a=r.seasons[0];p(a.season_number),a.episodes.length>0&&i(a.episodes[0].episode_number)}},[r]),!r)return null;const o=()=>{v(n,l)},m=a=>{const g=Number(a.target.value);p(g);const w=r.seasons.find(j=>j.season_number===g);w&&w.episodes.length>0?i(w.episodes[0].episode_number):i(1)},c=r.seasons||[],d=((x=c.find(a=>a.season_number===n))==null?void 0:x.episodes)||[],b="w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 focus:border-cyan-500 outline-none transition cursor-pointer";return s.jsx(k,{isOpen:e,onClose:t,title:`أضف "${r.title}" للمشاهدة لاحقاً`,children:s.jsxs("div",{className:"space-y-6",children:[s.jsx("p",{className:"text-slate-300",children:"اختر الحلقة التي توقفت عندها للعودة إليها بسهولة لاحقًا."}),s.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"season",className:"block text-sm font-medium text-slate-300 mb-2",children:"الموسم"}),s.jsx("select",{id:"season",value:n,onChange:m,className:b,children:c.map(a=>s.jsxs("option",{value:a.season_number,children:["الموسم ",a.season_number]},a.season_number))})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"episode",className:"block text-sm font-medium text-slate-300 mb-2",children:"الحلقة"}),s.jsx("select",{id:"episode",value:l,onChange:a=>i(Number(a.target.value)),className:b,children:d.map(a=>s.jsxs("option",{value:a.episode_number,children:["الحلقة ",a.episode_number,": ",a.title]},a.episode_number))})]})]}),s.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t border-slate-700",children:[s.jsx("button",{onClick:t,disabled:h,className:"bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-colors disabled:opacity-50",children:"إلغاء"}),s.jsxs("button",{onClick:o,disabled:h,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800 disabled:cursor-not-allowed",children:[h&&s.jsx(C,{}),h?"جاري الحفظ...":"حفظ واستئناف"]})]})]})})};export{W as R,T as S,M as a,R as u};
