import{r,a as ee,d as k,j as s}from"./index-Dz2DXnM8.js";import{S as te,G as se,T as ae,Y as re}from"./TagFilter-DYyTPdAf.js";import{M as ne}from"./MovieGridSkeleton-eo5LrZbc.js";import{P as le}from"./Pagination-C-vk0JvX.js";import{S as oe}from"./SeriesGrid-Cs21YUq1.js";import{a as ce,R as ie}from"./ResumeFromModal-2gxD57xZ.js";import"./MovieCardSkeleton-D_IMjcnN.js";import"./SpinnerIcon-DCw0DtRn.js";const w=30,C="cached_series",de=900*1e3,ye=()=>{const[i,N]=r.useState([]),[F,I]=r.useState([]),[W,v]=r.useState(!0),[l,h]=r.useState("all"),[o,x]=r.useState([]),[c,f]=r.useState([]),[d,Y]=r.useState("createdAt_desc"),[u,A]=ee(),M=r.useRef(!0),{addWatchLaterSeries:O,removeWatchLaterSeries:B,isWatchLaterSeries:D,getWatchLaterInfo:T,loading:$}=ce(),[m,p]=r.useState(null),g=parseInt(u.get("page")||"1",10),R=r.useCallback(e=>{const t=new URLSearchParams(u);e<=1?t.delete("page"):t.set("page",e.toString()),A(t,{replace:!0}),window.scrollTo(0,0)},[u,A]);r.useEffect(()=>{(async()=>{try{const t=localStorage.getItem(C);if(t){const{data:a,timestamp:n}=JSON.parse(t);if(new Date().getTime()-n<de){N(a),v(!1);return}}}catch(t){console.error("Error reading from series cache",t),localStorage.removeItem(C)}try{const a=(await k.collection("series").orderBy("createdAt","desc").get()).docs.map(n=>({id:n.id,...n.data()}));N(a);try{const n={data:a,timestamp:new Date().getTime()};localStorage.setItem(C,JSON.stringify(n))}catch(n){console.error("Error writing to series cache",n)}}catch(t){console.error("Error fetching series: ",t)}finally{v(!1)}})()},[]),r.useEffect(()=>{const e=k.collection("categories").orderBy("name").onSnapshot(t=>{const a=t.docs.map(n=>n.data().name);I(a)},t=>{console.error("Error fetching categories: ",t)});return()=>e()},[]);const E=e=>x(t=>t.includes(e)?t.filter(a=>a!==e):[...t,e]),H=()=>x([]),P=e=>f(t=>t.includes(e)?t.filter(a=>a!==e):[...t,e]),J=()=>f([]),U=()=>{h("all"),x([]),f([])},z=e=>{D(e.id)?B(e.id):p(e)},K=(e,t)=>{m&&O(m.id,e,t),p(null)},q=[...new Set(i.map(e=>e.year))].sort((e,t)=>t-e),Q=F,V=[...new Set(i.flatMap(e=>e.tags||[]))].sort(),S=r.useMemo(()=>i.filter(e=>l==="all"||e.year.toString()===l).filter(e=>o.length===0||o.some(t=>{var a;return(a=e.genres)==null?void 0:a.includes(t)})).filter(e=>c.length===0||c.some(t=>{var a;return(a=e.tags)==null?void 0:a.includes(t)})).sort((e,t)=>{var a,n,G,L;switch(d){case"rating_desc":return(t.imdbRating||0)-(e.imdbRating||0);case"rating_asc":return(e.imdbRating||0)-(t.imdbRating||0);case"year_desc":return t.year-e.year;case"year_asc":return e.year-t.year;case"createdAt_asc":{const b=(a=e.createdAt)!=null&&a.toMillis?e.createdAt.toMillis():0,j=(n=t.createdAt)!=null&&n.toMillis?t.createdAt.toMillis():0;return b-j}case"createdAt_desc":default:{const b=(G=t.createdAt)!=null&&G.toMillis?t.createdAt.toMillis():0,j=(L=e.createdAt)!=null&&L.toMillis?e.createdAt.toMillis():0;return b-j}}}),[i,l,o,c,d]);r.useEffect(()=>{if(M.current){M.current=!1;return}g!==1&&R(1)},[l,o,c,d]);const _=Math.ceil(S.length/w),y=S.slice((g-1)*w,g*w),X=l!=="all"||o.length>0||c.length>0,Z=r.useMemo(()=>new Map(y.map(e=>{const t=T(e.id);return[e.id,t?{season:t.season,episode:t.episode}:null]})),[y,T]);return W?s.jsxs("div",{className:"animate-fade-in",children:[s.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),s.jsx("div",{className:"my-8 h-20 bg-slate-800/50 rounded-lg animate-pulse"}),s.jsx(ne,{count:18})]}):s.jsxs("div",{className:"animate-fade-in",children:[s.jsx(ie,{isOpen:!!m,onClose:()=>p(null),series:m,onSave:K,isSaving:$}),s.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),s.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:s.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[s.jsx(te,{sortOrder:d,onSortChange:Y}),s.jsx(se,{genres:Q,selectedGenres:o,onToggleGenre:E,onClearGenres:H}),s.jsx(ae,{tags:V,selectedTags:c,onToggleTag:P,onClearTags:J}),s.jsx(re,{years:q,selectedYear:l,onYearChange:h})]})}),X&&s.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-slate-800/50 p-3 animate-fade-in-down",children:[s.jsx("span",{className:"font-bold text-slate-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[l!=="all"&&s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",l,s.jsx("button",{onClick:()=>h("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${l}`,children:"×"})]}),o.map(e=>s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,s.jsx("button",{onClick:()=>E(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),c.map(e=>s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,s.jsx("button",{onClick:()=>P(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),s.jsx("button",{onClick:U,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),s.jsx("section",{className:"mb-12",children:S.length>0?s.jsxs(s.Fragment,{children:[s.jsx(oe,{series:y,onToggleWatchLater:z,watchLaterInfoMap:Z}),_>1&&s.jsx(le,{currentPage:g,totalPages:_,onPageChange:R})]}):s.jsx("div",{className:"text-center p-8 bg-slate-800 rounded-lg mt-8",children:s.jsx("p",{className:"text-xl text-slate-400",children:"لا توجد مسلسلات تطابق معايير البحث."})})})]})};export{ye as default};
