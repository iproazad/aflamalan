import{r,a as Q,s as S,j as a}from"./index-DLOQmAiS.js";import{S as V,G as X,T as ee,Y as te}from"./TagFilter-BtRfVG1f.js";import{M as ae}from"./MovieGridSkeleton-BIC0evs_.js";import{P as se}from"./Pagination-BQtzf5ih.js";import{S as re}from"./SeriesGrid-C1YPQISH.js";import{a as ne,R as le}from"./ResumeFromModal-8T4Cf5bK.js";import"./MovieCardSkeleton-B2tHPRXo.js";import"./SpinnerIcon-B4FaeE9s.js";const _=30,T="cached_series",ce=900*1e3,oe=async()=>{let n=[],i=0;const d=1e3;for(;;){const{data:m,error:g,count:h}=await S.from("series").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(i,i+d-1);if(g)throw console.error("Error fetching series batch:",g),g;if(m){if(n=n.concat(m),n.length>=(h??0)||m.length<d)break;i+=d}else break}return n},pe=()=>{const[n,i]=r.useState([]),[d,m]=r.useState([]),[g,h]=r.useState(!0),[l,b]=r.useState("all"),[c,y]=r.useState([]),[o,j]=r.useState([]),[f,L]=r.useState("createdAt_desc"),[w,E]=Q(),A=r.useRef(!0),{addWatchLaterSeries:F,removeWatchLaterSeries:M,isWatchLaterSeries:D,getWatchLaterInfo:P,loading:W}=ne(),[u,N]=r.useState(null),x=parseInt(w.get("page")||"1",10),R=r.useCallback(e=>{const t=new URLSearchParams(w);e<=1?t.delete("page"):t.set("page",e.toString()),E(t,{replace:!0}),window.scrollTo(0,0)},[w,E]);r.useEffect(()=>{(async()=>{try{const t=localStorage.getItem(T);if(t){const{data:s,timestamp:p}=JSON.parse(t);if(new Date().getTime()-p<ce){i(s),h(!1);return}}}catch(t){console.error("Error reading from series cache",t),localStorage.removeItem(T)}try{const t=await oe();i(t);try{const s={data:t,timestamp:new Date().getTime()};localStorage.setItem(T,JSON.stringify(s))}catch(s){console.error("Error writing to series cache",s)}}catch(t){console.error("Error fetching series: ",t)}finally{h(!1)}})()},[]),r.useEffect(()=>{const e=async()=>{const{data:s,error:p}=await S.from("categories").select("name").order("name");p?console.error("Error fetching categories: ",p):m(s.map(q=>q.name))};e();const t=S.channel("public:categories:series").on("postgres_changes",{event:"*",schema:"public",table:"categories"},e).subscribe();return()=>{S.removeChannel(t)}},[]);const k=e=>y(t=>t.includes(e)?t.filter(s=>s!==e):[...t,e]),Y=()=>y([]),G=e=>j(t=>t.includes(e)?t.filter(s=>s!==e):[...t,e]),O=()=>j([]),H=()=>{b("all"),y([]),j([])},$=e=>{D(e.id)?M(e.id):N(e)},J=(e,t)=>{u&&F(u.id,e,t),N(null)},U=[...new Set(n.map(e=>e.year))].sort((e,t)=>t-e),z=d,B=[...new Set(n.flatMap(e=>e.tags||[]))].sort(),C=r.useMemo(()=>n.filter(e=>l==="all"||e.year.toString()===l).filter(e=>c.length===0||c.some(t=>{var s;return(s=e.genres)==null?void 0:s.includes(t)})).filter(e=>o.length===0||o.some(t=>{var s;return(s=e.tags)==null?void 0:s.includes(t)})).sort((e,t)=>{switch(f){case"rating_desc":return(t.imdb_rating||0)-(e.imdb_rating||0);case"rating_asc":return(e.imdb_rating||0)-(t.imdb_rating||0);case"year_desc":return Number(t.year)-Number(e.year);case"year_asc":return Number(e.year)-Number(t.year);case"createdAt_asc":return Date.parse(e.created_at)-Date.parse(t.created_at);case"createdAt_desc":default:return Date.parse(t.created_at)-Date.parse(e.created_at)}}),[n,l,c,o,f]);r.useEffect(()=>{if(A.current){A.current=!1;return}x!==1&&R(1)},[l,c,o,f]);const I=Math.ceil(C.length/_),v=C.slice((x-1)*_,x*_),K=l!=="all"||c.length>0||o.length>0,Z=r.useMemo(()=>new Map(v.map(e=>{const t=P(e.id);return[e.id,t?{season:t.season,episode:t.episode}:null]})),[v,P]);return g?a.jsxs("div",{className:"animate-fade-in",children:[a.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),a.jsx("div",{className:"my-8 h-20 bg-slate-800/50 rounded-lg animate-pulse"}),a.jsx(ae,{count:18})]}):a.jsxs("div",{className:"animate-fade-in",children:[a.jsx(le,{isOpen:!!u,onClose:()=>N(null),series:u,onSave:J,isSaving:W}),a.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),a.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:a.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[a.jsx(V,{sortOrder:f,onSortChange:L}),a.jsx(X,{genres:z,selectedGenres:c,onToggleGenre:k,onClearGenres:Y}),a.jsx(ee,{tags:B,selectedTags:o,onToggleTag:G,onClearTags:O}),a.jsx(te,{years:U,selectedYear:l,onYearChange:b})]})}),K&&a.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-slate-800/50 p-3 animate-fade-in-down",children:[a.jsx("span",{className:"font-bold text-slate-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),a.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[l!=="all"&&a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",l,a.jsx("button",{onClick:()=>b("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${l}`,children:"×"})]}),c.map(e=>a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,a.jsx("button",{onClick:()=>k(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),o.map(e=>a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,a.jsx("button",{onClick:()=>G(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),a.jsx("button",{onClick:H,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),a.jsx("section",{className:"mb-12",children:C.length>0?a.jsxs(a.Fragment,{children:[a.jsx(re,{series:v,onToggleWatchLater:$,watchLaterInfoMap:Z}),I>1&&a.jsx(se,{currentPage:x,totalPages:I,onPageChange:R})]}):a.jsx("div",{className:"text-center p-8 bg-slate-800 rounded-lg mt-8",children:a.jsx("p",{className:"text-xl text-slate-400",children:"لا توجد مسلسلات تطابق معايير البحث."})})})]})};export{pe as default};
