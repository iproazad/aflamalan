import{r,d as G,j as s}from"./index-Xnn5P2js.js";import{S as V,G as X,T as Z,Y as ee}from"./TagFilter-ZqX4GVXD.js";import{M as te}from"./MovieGridSkeleton-D9oBikS3.js";import{P as se}from"./Pagination-BdYH8eLj.js";import{S as ae}from"./SeriesGrid-BUdB-073.js";import{a as re,R as le}from"./ResumeFromModal-CQBk6nvN.js";import"./MovieCardSkeleton-CVAo5cov.js";import"./SpinnerIcon-BbBLGSQv.js";const j=30,N="cached_series",ne=900*1e3,fe=()=>{const[i,v]=r.useState([]),[F,L]=r.useState([]),[k,w]=r.useState(!0),[n,g]=r.useState("all"),[o,x]=r.useState([]),[c,h]=r.useState([]),[d,I]=r.useState("createdAt_desc"),[f,C]=r.useState(1),{addWatchLaterSeries:P,removeWatchLaterSeries:W,isWatchLaterSeries:Y,getWatchLaterInfo:A,loading:O}=re(),[m,u]=r.useState(null);r.useEffect(()=>{(async()=>{try{const t=localStorage.getItem(N);if(t){const{data:a,timestamp:l}=JSON.parse(t);if(new Date().getTime()-l<ne){v(a),w(!1);return}}}catch(t){console.error("Error reading from series cache",t),localStorage.removeItem(N)}try{const a=(await G.collection("series").orderBy("createdAt","desc").get()).docs.map(l=>({id:l.id,...l.data()}));v(a);try{const l={data:a,timestamp:new Date().getTime()};localStorage.setItem(N,JSON.stringify(l))}catch(l){console.error("Error writing to series cache",l)}}catch(t){console.error("Error fetching series: ",t)}finally{w(!1)}})()},[]),r.useEffect(()=>{const e=G.collection("categories").orderBy("name").onSnapshot(t=>{const a=t.docs.map(l=>l.data().name);L(a)},t=>{console.error("Error fetching categories: ",t)});return()=>e()},[]);const M=e=>x(t=>t.includes(e)?t.filter(a=>a!==e):[...t,e]),B=()=>x([]),T=e=>h(t=>t.includes(e)?t.filter(a=>a!==e):[...t,e]),D=()=>h([]),$=()=>{g("all"),x([]),h([])},H=e=>{Y(e.id)?W(e.id):u(e)},J=(e,t)=>{m&&P(m.id,e,t),u(null)},z=[...new Set(i.map(e=>e.year))].sort((e,t)=>t-e),K=F,U=[...new Set(i.flatMap(e=>e.tags||[]))].sort(),p=r.useMemo(()=>i.filter(e=>n==="all"||e.year.toString()===n).filter(e=>o.length===0||o.some(t=>{var a;return(a=e.genres)==null?void 0:a.includes(t)})).filter(e=>c.length===0||c.some(t=>{var a;return(a=e.tags)==null?void 0:a.includes(t)})).sort((e,t)=>{var a,l,R,_;switch(d){case"rating_desc":return(t.imdbRating||0)-(e.imdbRating||0);case"rating_asc":return(e.imdbRating||0)-(t.imdbRating||0);case"year_desc":return t.year-e.year;case"year_asc":return e.year-t.year;case"createdAt_asc":{const y=(a=e.createdAt)!=null&&a.toMillis?e.createdAt.toMillis():0,b=(l=t.createdAt)!=null&&l.toMillis?t.createdAt.toMillis():0;return y-b}case"createdAt_desc":default:{const y=(R=t.createdAt)!=null&&R.toMillis?t.createdAt.toMillis():0,b=(_=e.createdAt)!=null&&_.toMillis?e.createdAt.toMillis():0;return y-b}}}),[i,n,o,c,d]);r.useEffect(()=>{C(1)},[n,o,c,d]);const E=Math.ceil(p.length/j),S=p.slice((f-1)*j,f*j),q=n!=="all"||o.length>0||c.length>0,Q=r.useMemo(()=>new Map(S.map(e=>{const t=A(e.id);return[e.id,t?{season:t.season,episode:t.episode}:null]})),[S,A]);return k?s.jsxs("div",{className:"animate-fade-in",children:[s.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),s.jsx("div",{className:"my-8 h-20 bg-slate-800/50 rounded-lg animate-pulse"}),s.jsx(te,{count:18})]}):s.jsxs("div",{className:"animate-fade-in",children:[s.jsx(le,{isOpen:!!m,onClose:()=>u(null),series:m,onSave:J,isSaving:O}),s.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),s.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:s.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[s.jsx(V,{sortOrder:d,onSortChange:I}),s.jsx(X,{genres:K,selectedGenres:o,onToggleGenre:M,onClearGenres:B}),s.jsx(Z,{tags:U,selectedTags:c,onToggleTag:T,onClearTags:D}),s.jsx(ee,{years:z,selectedYear:n,onYearChange:g})]})}),q&&s.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-slate-800/50 p-3 animate-fade-in-down",children:[s.jsx("span",{className:"font-bold text-slate-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[n!=="all"&&s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",n,s.jsx("button",{onClick:()=>g("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${n}`,children:"×"})]}),o.map(e=>s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,s.jsx("button",{onClick:()=>M(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),c.map(e=>s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,s.jsx("button",{onClick:()=>T(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),s.jsx("button",{onClick:$,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),s.jsx("section",{className:"mb-12",children:p.length>0?s.jsxs(s.Fragment,{children:[s.jsx(ae,{series:S,onToggleWatchLater:H,watchLaterInfoMap:Q}),E>1&&s.jsx(se,{currentPage:f,totalPages:E,onPageChange:C})]}):s.jsx("div",{className:"text-center p-8 bg-slate-800 rounded-lg mt-8",children:s.jsx("p",{className:"text-xl text-slate-400",children:"لا توجد مسلسلات تطابق معايير البحث."})})})]})};export{fe as default};
